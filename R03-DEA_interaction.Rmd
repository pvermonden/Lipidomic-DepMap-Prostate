---
author: "Manon Martin"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output: 
  html_document:
    smart: FALSE
    code_folding: hide
    collapsed: yes
    fig_caption: yes
    highlight: tango
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  finaltrans1: "log"
  whatdata1: "prostate"
editor_options: 
  chunk_output_type: console
---

```{r}
rm(list=ls())
```

---
title: "R03 - DEA"
---

```{r setup, include=FALSE}
# clear the environment ===============


# specify knitr options -----------------------
knitr::opts_chunk$set(echo = TRUE)

# load packages -----------------------

# packages from CRAN
library(ggplot2)
library(dplyr)
library(SummarizedExperiment)
library(tidyverse)
library(ggrepel)
library(pander)
library(QFeatures)
library(missMDA)
library(tidyverse)
library(gplots)
library(readxl)
library(missMDA)
library(dplyr)
library(factoextra)
library(missMDA)
library("FactoMineR")
library(ComplexHeatmap)
library(viridis)
library(plotly)
library(xlsx)
library(caret)
library(randomForest)
library(glmnet)
library(readr)
library(knitr) 
library(UpSetR)
library(proDA)
library(limma)
library(patchwork)
library(lipidr)
library(missForest)
library(doParallel)
library(clusterProfiler)
library(Vennerable)
library("GGally")
library(fgsea)
library("RColorBrewer")
```

# Notes

- Differential Expression Analysis (DEA): proDA for DEA (no imputation, takes into account missing values)

- Enrichment analysis (GSEA)


## Current set-up


```{r}
Lipid_Class_col <- c("brown", "brown1", "chocolate1", "orange", "gold",
                     "olivedrab1", "olivedrab", "limegreen","mediumseagreen",
                     "cadetblue1",  "darkcyan", "blue","darkblue",
                     "darkviolet", "deeppink") 


```



Differential expression analysis (DEA) with all the cell lines.

- regression with `proDA`, for all the cell lines
- formula: `Treatment`+ `Cell.Line` + `Cell.Line`:`Treatment`


# prostate

```{r}
load(file = paste0("processed_data/R02_se_prostate.rda"))
```


Reference cell line: `22RV1`
Reference treatment: `Control`

```{r}
se$Treatment <- gsub(" |-","_",se$Treatment)
se$Treatment <- gsub("_+","_",se$Treatment)
rd <- rowData(se)

se$CL_Trt <- paste(se$Cell.Line, se$Treatment,sep = "_")
cd <- colData(se) %>% as.data.frame() %>% rownames_to_column("colname") 

X <- assays(se)$log %>% as.data.frame() %>% 
  rownames_to_column()%>% pivot_longer(-rowname, names_to = "colname") %>%
  left_join(cd, by = "colname")

df_NA <- X %>% group_by(Cell.Line, Treatment, rowname) %>%
  summarize(sumNAs = sum(is.na(value)))
df_NA$CL_trt <- paste(df_NA$Cell.Line, df_NA$Treatment, sep = "_")
  

table(se$CL_Trt)
se$CL_Trt <- make.names(se$CL_Trt)

evalproDA <- FALSE

if (evalproDA){
  # fit <- proDA(assays(se)$log, design = se$CL_Trt)
  # save(fit, file = "results/R03_fitProDA_prostate.rda")
    se_sub <- list()
  for (i in unique(rd$Lipid_Class)){
    se_sub[[i]] <- se[rd$Lipid_Class==i,]
  }
  fit_list <- lapply(se_sub, function(x) 
    proDA(assays(x)$log, design = x$CL_Trt))
  save(fit_list, file = "results/R03_fitProDA_prostate.rda")
}else{
  load(file = "results/R03_fitProDA_prostate.rda")
}

term2gene <- rowData(se) %>% as.data.frame() %>%
    rownames_to_column("lipid") %>% 
    select(c("Lipid_Class","lipid"))

# for heatmaps
Treatment_col = c("Control" = "red", "ALA10" ="green" ,
                    "Fer1_3" = "goldenrod2",
                    "PunA2.5" = "darkturquoise", "PunA5" = "dodgerblue", 
                    "PunA10" = "dodgerblue4", "PunA10_fer13" = "darkorchid3")

```


```{r}
fun_sign <- function(res){
  res$sign <- 0
  res$sign[res$diff>0 &res$adj_pval<0.05 ] = 1
  res$sign[res$diff<0 &res$adj_pval<0.05 ] = -1
  res$sign
}

merge_res_prostate <- function(append = FALSE, 
                               pairs = FALSE){
  
  compare <- paste(cdt1,"vs",cdt2)
  pander(compare)
  inter1 <- paste0("(LNCaP_",cdt1," - LNCaP_",cdt2,") - ",
                 "(X22RV1_",cdt1," - X22RV1_",cdt2,")")
  inter2 <- paste0("(PC3_",cdt1," - PC3_",cdt2,") - ",
                 "(X22RV1_",cdt1," - X22RV1_",cdt2,")")

  ### Effects of treatment, per cell line

  # main effect
  name1 <-  paste0("X22RV1_",cdt1," - X22RV1_",cdt2)
  pander(name1)
  # res_td1 <- test_diff(fit, name1, sort_by = NULL)
  res_td1 <- lapply(fit_list, function(x) test_diff(x, name1, sort_by = NULL))
  res_td1 <- do.call(rbind,res_td1)
  res_td1$adj_pval <- p.adjust(res_td1$pval,method = "fdr")
  
  res_td1$adj_pval[res_td1$adj_pval == 0] <- 
    min(res_td1$adj_pval[res_td1$adj_pval > 0])
  res_td1$sign <- fun_sign(res_td1)
  res_td1 %>% dplyr::select(name, pval, adj_pval, diff, t_statistic) %>% 
    arrange(pval) %>% filter(adj_pval<0.05)  %>% pander()
  
  # main effect
  name2 <-  paste0("LNCaP_",cdt1," - LNCaP_",cdt2)
  pander(name2)
  # res_td2 <- test_diff(fit, name2, sort_by = NULL)
  res_td2 <- lapply(fit_list, function(x) test_diff(x, name2, sort_by = NULL))
  res_td2 <- do.call(rbind,res_td2)
  res_td2$adj_pval <- p.adjust(res_td2$pval,method = "fdr")
  
  res_td2$adj_pval[res_td2$adj_pval == 0] <- 
    min(res_td2$adj_pval[res_td2$adj_pval > 0])
  res_td2$sign <- fun_sign(res_td2)
  res_td2 %>% dplyr::select(name, pval, adj_pval, diff, t_statistic) %>%
    arrange(pval)%>% filter(adj_pval<0.05)  %>% pander()
  
  # main effect
  name3 <-  paste0("PC3_",cdt1," - PC3_",cdt2)
  pander(name3)
  # res_td3 <- test_diff(fit, name3, sort_by = NULL)
  res_td3 <- lapply(fit_list, function(x) test_diff(x, name3, sort_by = NULL))
  res_td3 <- do.call(rbind,res_td3)
  res_td3$adj_pval <- p.adjust(res_td3$pval,method = "fdr")
  res_td3$adj_pval[res_td3$adj_pval == 0] <- 
    min(res_td3$adj_pval[res_td3$adj_pval > 0])
  res_td3$sign <- fun_sign(res_td3)
  res_td3 %>% dplyr::select(name, pval, adj_pval, diff, t_statistic) %>% 
    arrange(pval)%>% filter(adj_pval<0.05)  %>% pander()
  
  
  # interaction terms
  name_int1 <- paste0("int_LNCaP_",cdt1,"_",cdt2)
  name_int2 <- paste0("int_PC3_",cdt1,"_",cdt2)
  
  pander(name_int1)
  # res_td_inter1 <- test_diff(fit, inter1, 
  #                      sort_by = NULL)
  res_td_inter1 <- lapply(fit_list, function(x) test_diff(x, inter1, sort_by = NULL))
  res_td_inter1 <- do.call(rbind,res_td_inter1)
  res_td_inter1$adj_pval <- p.adjust(res_td_inter1$pval,method = "fdr")
  
  res_td_inter1$sign <- fun_sign(res_td_inter1)
  res_td_inter1 %>% dplyr::select(name, pval, adj_pval, diff, t_statistic) %>% 
    arrange(pval)%>% filter(adj_pval<0.05)  %>% pander()
  
  pander(name_int2)
  # res_td_inter2 <- test_diff(fit, inter2, 
  #                      sort_by = NULL)
  res_td_inter2 <- lapply(fit_list, function(x) test_diff(x, inter2, sort_by = NULL))
  res_td_inter2 <- do.call(rbind,res_td_inter2)
  res_td_inter2$adj_pval <- p.adjust(res_td_inter2$pval,method = "fdr")
  res_td_inter2$sign <- fun_sign(res_td_inter2)
  res_td_inter2 %>% dplyr::select(name, pval, adj_pval, diff, t_statistic) %>% 
    arrange(pval)%>% filter(adj_pval<0.05)  %>% pander()

  ### all together
  test <- c(rep(name1, nrow(res_td1)), 
            rep(name2, nrow(res_td2)),
            rep(name3, nrow(res_td3)),
            rep(name_int1, nrow(res_td_inter1)),
            rep(name_int2, nrow(res_td_inter2)))
  
  test <- factor(test, levels = c(name1, name2, name3, name_int1, name_int2))
 
  
  #####
  test2 <- c(name1,name2, name3, inter1, inter2)
  
  df_NA_wide <- df_NA %>% ungroup() %>% 
  dplyr::select(!c(Cell.Line, Treatment)) %>% 
  pivot_wider(names_from = CL_trt, values_from = sumNAs) 

  t2 <- gsub("X22RV1","22RV1", test2)

  tex <- strsplit(t2, split = "-")
  tex <- lapply(tex, function(x) gsub(" |\\(|\\)","",x))
  names(tex) <- c(name1, name2, name3, name_int1, name_int2)
  
  matNumNA = matrix(NA, ncol=3, nrow=length(test))
  numNA = c()
  for (i in 1:length(tex)){
    a = do.call(paste0, as.data.frame(df_NA_wide[,tex[[i]]]))
    names(a) = df_NA_wide$rowname
    numNA = c(numNA, a)
  }
  
  matNumNA = data.frame(name = names(numNA), numNA, 
                        test = rep(names(tex),each = nrow(df_NA_wide)))
  
  ####
  
  df_all <- data.frame(name = rep(res_td1$name,5), test, 
                  lipid_Class = rep(rd$Lipid_Class,5), 
                       logFC = c(res_td1$diff,res_td2$diff,res_td3$diff,
                          res_td_inter1$diff, res_td_inter2$diff),
                  t_statistic = c(res_td1$t_statistic,
                                  res_td2$t_statistic, res_td3$t_statistic,
                          res_td_inter1$t_statistic, res_td_inter2$t_statistic),
                  adj_pval = c(res_td1$adj_pval,res_td2$adj_pval, res_td3$adj_pval,
                          res_td_inter1$adj_pval, res_td_inter2$adj_pval),
                  sign = c(res_td1$sign,res_td2$sign, res_td3$sign,
                          res_td_inter1$sign, res_td_inter2$sign))
  
  df_all <- df_all %>% left_join(matNumNA, by = c("name", "test"))
  
  df_all_wide <- df_all %>% pivot_wider(names_from = test, 
                           values_from = c(logFC, adj_pval, numNA,
                                            sign, t_statistic))
  ### volcano plots
  p_VP <- df_all %>% ggplot(aes(x = logFC, y = -log10(adj_pval),
                           label = name)) +
  geom_point(aes(color = lipid_Class)) + 
  facet_wrap(~test)+ 
  theme_bw() + ggtitle(compare) + 
  scale_color_manual(values = Lipid_Class_col) +
  geom_hline(yintercept = -log10(0.05), 
             linetype=2, color="blue")
  
  # only lipids not totally missing in one condition
  a = expand.grid(c(0,3),c(0,3), c(0,3),c(0,3))
  val4 = do.call(paste0, as.data.frame(a))
  val4 = val4[val4!="0000"]
  val2 = c("30", "03", "33")
  
  df_all_sub = df_all[!df_all$numNA %in% c(val2,val4),]
  p_VP2 <- df_all_sub %>% ggplot(aes(x = logFC, y = -log10(adj_pval),
                           label = name)) +
  geom_point(aes(color = lipid_Class)) + 
  facet_wrap(~test)+ 
  theme_bw() + ggtitle(compare) + 
  scale_color_manual(values = Lipid_Class_col) +
  geom_hline(yintercept = -log10(0.05), 
             linetype=2, color="blue")
  
  ### pairs plots
  upperfun <- function(data,mapping){
    ggplot(data = data, mapping = mapping)+
      geom_point()+
      geom_abline(intercept=0,slope=1, color="gray")   +
      scale_x_continuous(limits =range_val) +
      scale_y_continuous(limits = range_val)
  }
  lowerfun <- function(data,mapping){
    ggplot(data = data, mapping = mapping)+
      geom_point()+
      geom_abline(intercept=0,slope=1, color="gray") +
      scale_x_continuous(limits = range_val) +
      scale_y_continuous(limits = range_val)
  }
  
  p_logFC <- p_pvals <- NULL
  if (pairs){
    # foldchanges
    range_val <- range(df_all_wide[,c(3:7)], na.rm = TRUE)
    p_logFC <- ggpairs(df_all_wide[,c(3:7)],
                       upper = list(continuous = wrap(upperfun)),
            lower = list(continuous = wrap(lowerfun)), 
            diag = list(continuous = "blankDiag")) 
    
    # p_logFC
    # ggplotly(p_logFC)
    
    # pvals
    range_val <- range(-log10(df_all_wide[,c(8:12)]), na.rm = TRUE)
    p_pvals <- ggpairs(-log10(df_all_wide[,c(8:12)]),
                       upper = list(continuous = wrap(upperfun)),
            lower = list(continuous = wrap(lowerfun)), 
            diag = list(continuous = "blankDiag")) 
    
    # p_pvals
    # ggplotly(p_pvals) 
  }
  
  
  #### upsetplot
  
  df <- data.frame(res_td1$sign,res_td2$sign,res_td3$sign,
                          res_td_inter1$sign, res_td_inter2$sign)
  colnames(df) <- c(name1, name2, name3, name_int1, name_int2)
  us_pos <- df %>% as.data.frame() %>% dplyr::mutate_all(~ifelse(.x==1,1,0))
  us_neg <- df %>% as.data.frame() %>% dplyr::mutate_all(~ifelse(.x==-1,1,0))
 
  
  list_ret <- list(df_all=df_all, df_all_wide=df_all_wide, 
                   p_logFC = p_logFC, p_pvals = p_pvals, p_VP = p_VP,
                   p_VP2 = p_VP2,
                   us_pos = us_pos,us_neg=us_neg, effects = tex)
  
  
  #### save results
  write.xlsx(df_all_wide, file = "results/R03_prostate.xlsx",
             sheetName = gsub(" ","",compare), append = append)
  
  return(list_ret)
  
}


#### heatmaps
ht_fun <- function(){
  X <- res$df_all_wide %>% select(c(name,starts_with("logFC_")))
  Y <- res$df_all_wide %>% select(starts_with("adj_pval_"))
  if (sum(Y<0.05)>1){
     
  for (i in 2:ncol(X)){
    X[Y[,(i-1)]>=0.05,i] = NA
  }
  
  # FC
  X_fc = X[rowSums(is.na(X))!=(ncol(X)-1),-1]  %>% as.matrix()
  rownames(X_fc) <- X$name[rowSums(is.na(X))!=(ncol(X)-1)]
  col1 = circlize::colorRamp2(seq(-max(X_fc, na.rm=TRUE), 
                        max(X_fc, na.rm=TRUE), length = 3),
                        c("blue","white","red"))
  names_sig <- X[rowSums(is.na(X))!=(ncol(X)-1),1] %>% pull()
  ht1 <- Heatmap(X_fc, cluster_rows = FALSE, cluster_columns = FALSE, 
          column_title = "Fold changes", col=col1, 
          row_names_gp = gpar(fontsize = 8), 
          column_names_gp  = gpar(fontsize = 8))
  
  # raw values
  X_raw <- assays(se)$raw
  cols <- rev(heat.colors(20))
  X_raw <- X_raw[names_sig,] %>% as.matrix()
  cdtrt <- colData(se)[colnames(X_raw),"Treatment"]
  row_ha = HeatmapAnnotation(Treatment = cdtrt, 
                                col = list(Treatment = Treatment_col),
                             which = "column" )
  ht2 <- Heatmap(X_raw, cluster_rows = FALSE, cluster_columns = FALSE, 
          column_title = "raw values", bottom_annotation = row_ha,
          col=cols, row_names_gp = gpar(fontsize = 8), 
          column_names_gp  = gpar(fontsize = 8))
  
  # z scores
  z_scores_fun <- function(data) {(data-mean(data, na.rm=TRUE))/sd(data, na.rm=TRUE)}
  
  X_zscore <- t(apply(X_raw, 1,z_scores_fun))
  
  col1 = circlize::colorRamp2(seq(-max(X_zscore, na.rm=TRUE), 
                        max(X_zscore, na.rm=TRUE), length = 3),
                        c("blue","white","red"))
  
  cdtrt <- colData(se)[colnames(X_raw),"Treatment"]
  row_ha = HeatmapAnnotation(Treatment = cdtrt, 
                                col = list(Treatment = Treatment_col),
                             which = "column" )
  ht3 <- Heatmap(X_zscore, cluster_rows = FALSE, cluster_columns = FALSE, 
          column_title = "z-scores", bottom_annotation = row_ha, col=col1,
          row_names_gp = gpar(fontsize = 8), 
          column_names_gp  = gpar(fontsize = 8))
  
  list(ht1,ht2,ht3)
  }
 
}
```

## F test for the interaction effect

```{r, eval=TRUE}
# load(file = paste0("processed_data/R02_se_",what_data,".rda"))


## -----------------------------------
# F test for the interaction effect

formFull <- ~ se$Treatment + se$Cell.Line + se$Treatment:se$Cell.Line
cat("formula: ", as.character(formFull))
design <- model.matrix(formFull)
fitlogFull <- proDA(assays(se)$log, design = design,
                          data_is_log_transformed = TRUE,
                           verbose = FALSE)
fitlogFull$convergence$successful

res <- test_diff(fitlogFull, 
                 reduced_model = ~ se$Treatment + se$Cell.Line ,
                       alternative = "two.sided",
                       pval_adjust_method = "BH",
                       sort_by = "adj_pval",
                       verbose = F) %>%
      as_tibble() %>% dplyr::rename("lipid" = "name", 
                             "adj.P.Val" = "adj_pval")
  

res[res$adj.P.Val<0.05,]

```


## PunA 10 vs CTL

```{r}
cdt1 <- "PunA10"
cdt2 <- "Control"
```


### DEA
```{r}
res <- merge_res_prostate(append = FALSE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)

pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()

```




### GSEA
```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```


## ALA 10 vs CTL

```{r}
cdt1 <- "ALA10"
cdt2 <- "Control"
```

### DEA

```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()
```

### GSEA
```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```

## ALA 10 vs PunA 20

```{r}
cdt1 <- "ALA10"
cdt2 <- "PunA10"
```

### DEA

```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()
```

### GSEA

```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```
## PunA 2.5	vs PunA 5

```{r}
cdt1 <- "PunA5"
cdt2 <- "PunA2.5"
```

### DEA
```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()

```

### GSEA

```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```
## PunA 5	vs PunA 10

```{r}
cdt1 <- "PunA10"
cdt2 <- "PunA5"
```

### DEA
```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()

```

### GSEA

```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```
## PunA 2.5	vs PunA 10

```{r}
cdt1 <- "PunA10"
cdt2 <- "PunA2.5"
```

### DEA
```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()
```

### GSEA

```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```
## CTL vs	Fer1_3

```{r}
cdt1 <- "Fer1_3"
cdt2 <- "Control"
```

### DEA
```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()

```

### GSEA

```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```
## PunA 10 vs	Fer1 - PunA 10

```{r}
cdt1 <- "PunA10_fer13"
cdt2 <- "PunA10"
```

### DEA
```{r}
res <- merge_res_prostate(append = TRUE)

pander("all the lipids")
res$p_VP
ggplotly(res$p_VP)

pander("only lipids not totally missing in ome condition")
res$p_VP2
ggplotly(res$p_VP2)


pander("upregulated")
if(sum(colSums(res$us_pos)>0)>1){
  UpSetR::upset(as.data.frame(res$us_pos), 
                keep.order = TRUE, nsets = ncol(res$us_pos)) %>%
    print()
}
pander("downregulated")
if(sum(colSums(res$us_neg)>0)>1){
  UpSetR::upset(as.data.frame(res$us_neg), 
                keep.order = TRUE, nsets = ncol(res$us_neg)) %>%
    print()
}

#### heatmaps
ht_fun()

```

### GSEA

```{r, eval=TRUE}

pander("GSEA")


df = res$df_all_wide
ranks <- df[,grep("t_statistic_",colnames(df), value=TRUE)]
colnames(ranks) <- sub("t_statistic_","",colnames(ranks))
ll = list()
for (i in unique(term2gene$Lipid_Class)){
  ll[[i]] = term2gene$lipid[term2gene$Lipid_Class==i]
}

for (i in 1:ncol(ranks)){
  print(colnames(ranks)[i])
  rank1 <- ranks[,i] %>% pull()
  names(rank1) = df$name
  fgsea::fgsea(ll,rank1) %>% arrange(pval) %>% print()
}
```
## ALL PunA

```{r}

all_punA = function(cellLine){
  
  res_list <- lapply(fit_list, function(x) test_diff(x, 
                         paste0(cellLine,"_PunA2.5 - ",
                                cellLine,"_Control"),
                       alternative = "two.sided",
                       pval_adjust_method = "BH",
                       sort_by = NULL,
                       verbose = F))
  res_PunA1 <-  do.call(rbind,res_list)
  res_PunA1$adj_pval <- p.adjust(res_PunA1$pval, method = "fdr")
  
  res_PunA1 = res_PunA1 %>%
      as_tibble() %>% dplyr::rename("lipid" = "name", 
                             "adj.P.Val" = "adj_pval")%>% 
  rename_all(~paste0(.x,"_PunA2.5"))

  
  res_list <- lapply(fit_list, function(x) test_diff(x, 
                         paste0(cellLine,"_PunA5 - ",
                                cellLine,"_Control"),
                       alternative = "two.sided",
                       pval_adjust_method = "BH",
                       sort_by = NULL,
                       verbose = F))
  res_PunA2 <-  do.call(rbind,res_list)
  res_PunA2$adj_pval <- p.adjust(res_PunA2$pval, method = "fdr")
  
  res_PunA2 = res_PunA2 %>%
        as_tibble() %>% dplyr::rename("lipid" = "name", 
                               "adj.P.Val" = "adj_pval")%>% 
    rename_all(~paste0(.x,"_PunA5"))
  
   res_list <- lapply(fit_list, function(x) test_diff(x, 
                         paste0(cellLine,"_PunA10 - ",
                                cellLine,"_Control"),
                       alternative = "two.sided",
                       pval_adjust_method = "BH",
                       sort_by = NULL,
                       verbose = F))
  res_PunA3 <-  do.call(rbind,res_list)
  res_PunA3$adj_pval <- p.adjust(res_PunA3$pval, method = "fdr")
  
  res_PunA3 = res_PunA3 %>%
        as_tibble() %>% dplyr::rename("lipid" = "name", 
                               "adj.P.Val" = "adj_pval") %>% 
    rename_all(~paste0(.x,"_PunA10"))
  
  
  df <- res_PunA1 %>% 
    inner_join(res_PunA2, by = c("lipid_PunA2.5"="lipid_PunA5")) %>% 
    inner_join(res_PunA3, by = c("lipid_PunA2.5"="lipid_PunA10"))  %>% 
    dplyr::rename("lipid_name"=lipid_PunA2.5) %>% 
    left_join(rownames_to_column(as.data.frame(rd)), 
              by = c("lipid_name"="rowname")) %>% 
    select(c(lipid_name,Lipid_Class, contains("diff"), 
             contains("adj.P.Val")))
  
  colnames(df) = sub("diff_","logFC_",colnames(df))
  colnames(df) = sub("adj.P.Val_","adjpval_",colnames(df))
  
  df_long = df %>% 
    pivot_longer(cols = c(contains("logFC_"),
                          contains("adjpval_"))) %>% 
      mutate(test = sub("logFC_|adjpval_","",name),
             name = sub("_.*","",name))%>%  
      pivot_wider(names_from = name, values_from = value)
  df_long$test = factor(df_long$test, 
                        levels = c("PunA2.5","PunA5","PunA10"))
  df_long$signif = df_long$adjpval<0.05
  
  p = df_long %>% ggplot(aes(x = test, y = logFC,
                         group = lipid_name)) +
    geom_line(color="darkgray", alpha=0.7) + 
    facet_wrap(~ Lipid_Class, scales = "free", ncol=3) +
    geom_point(aes(color=signif), alpha=0.7) + 
    scale_color_manual(values = c("darkgray","red")) +
    ggtitle(cellLine)
  p
}


```

```{r, fig.height=10}
p = all_punA("X22RV1")
p
ggplotly(p)

p = all_punA("LNCaP")
p
ggplotly(p)

p = all_punA("PC3")
p
ggplotly(p)
```



# sessionInfo

```{r}
sessionInfo()
```

